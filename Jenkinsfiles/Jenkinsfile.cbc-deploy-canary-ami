pipeline {
  agent {
    kubernetes {
      defaultContainer "bb2-cbc-build"
      yamlFile "Jenkinsfiles/cbc-build.yaml"
    }
  }

  environment {
    AWS_DEFAULT_REGION = "us-east-1"
    //TF_VARS = credentials("bb2-terraform-vars-${params.APP_ENV}-canary-2023")
    TF_IN_AUTOMATION = true
  }

  parameters {
    choice(
      name: "APP_ENV",
      choices: ["test", "impl", "prod"],
      description: "The environment to deploy to."
    )

    string(
      name: "APP_AMI_ID",
      defaultValue: "",
      description: "The AMI ID for the app image."
    )
  }

  stage("Assume AWS Role") {
      steps {
        withCredentials([
          string(credentialsId: "${params.APP_ENV == 'test' ? 'aws-assume-role-arn' : 'aws-assume-role-arn-prod'}", variable: 'ROLE_ARN')
        ]) {
          script {
            def sessionName = "jenkins-${env.BUILD_ID}"
            def credsJson = sh(
              script: """
                aws sts assume-role \\
                  --role-arn "$ROLE_ARN" \\
                  --role-session-name "$sessionName" \\
                  --output json
              """,
              returnStdout: true
            ).trim()

            def creds = readJSON text: credsJson

            env.AWS_ACCESS_KEY_ID     = creds.Credentials.AccessKeyId
            env.AWS_SECRET_ACCESS_KEY = creds.Credentials.SecretAccessKey
            env.AWS_SESSION_TOKEN     = creds.Credentials.SessionToken
            echo "Expiration: ${creds.Credentials.Expiration}"

            def callerIdentityStatus = sh(
              script: "aws sts get-caller-identity --output text",
              returnStatus: true
            )
            if (callerIdentityStatus != 0) {
              error("Failed to verify assumed AWS role.")
            } else {
              echo "Verified AWS role:\n${sh(script: 'aws sts get-caller-identity', returnStdout: true)}"
            }
          }
        }
      }
    }
    stage("Notify Slack") {
      steps {
        script {
          helpers = load "Jenkinsfiles/helpers.groovy"
          helpers.slackNotify "STARTING - ENV:${params.APP_ENV}"
        }
      }
    }


    stage("Terragrunt version") {
      steps {
        sh """
        terragrunt -v
        """
      }
    }

    stage("Run terragrunt Plan") {
      steps {
        withCredentials([file(credentialsId: "bb2-terraform-vars-${params.APP_ENV}-canary-2023", variable: 'TF_VARS_FILE')]) {
            sh """
            cd terraform/${APP_ENV}_canary
            terragrunt init --terragrunt-log-level error --terragrunt-disable-bucket-update -no-color -input=false
            terragrunt plan -no-color -input=false -out=tfplan -var-file='${TF_VARS}' -var='ami_id=${APP_AMI_ID}'
        }    """
      }
    }

    stage("Confirm Deployment") {
      input {
        message "Deploy this terraform plan to ${params.APP_ENV}?"
        ok "Deploy"
      }
      steps {
        echo "Deploy confirmation recieved, proceeding."
      }
    }

    // Terragrunt apply
    stage("Run Terraform Apply") {
      steps {
        sh """
        cd terraform/${APP_ENV}_canary
        terragrunt apply -no-color -input=false -auto-approve tfplan
        """
      }
    }

    stage("Wait For Canary") {
      steps {
        script {
          CANARY_IP = sh(returnStdout: true, script: "cd terraform/${APP_ENV}_canary; terraform output private_ip").trim()
        }

        sh """
        sleep 180
        curl -v --silent --insecure --retry 120 --retry-delay 15 --retry-connrefused --max-time 600 --connect-timeout 120 https://${CANARY_IP}/.well-known/openid-configuration
        """
      }
    }
  }

  post {
    success {
      script {
        helpers.slackNotify("SUCCESS - ENV:${params.APP_ENV}", "good")
      }
    }

    failure {
      script {
        helpers.slackNotify("FAILURE - ENV:${params.APP_ENV}", "bad")
      }
    }
  }
}