---
- name: Converge
  hosts: all
  gather_facts: false

  tasks:
    - name: Fetching data from iDRAC for PERC
      ansible.builtin.include_tasks:
        file: ../__extract_storage.yml
      vars:
        redfish_storage_volume_search_in_name: 'PERC'
        redfish_storage_volume_raid: "RAID0"

    - name: Fetching Volume_id from iDRAC
      ansible.builtin.include_tasks: ../__get_helper.yml
      vars:
        _url: "Systems/System.Embedded.1/Storage/{{ redfish_storage_volume_controller_id }}/Volumes"

    - name: Extracting volume_id
      ansible.builtin.set_fact:
        redfish_storage_volume_id: "{{ (redfish_storage_volume_fetched_output.json.Members | last)['@odata.id'] | ansible.builtin.split('/') | last }}"

    - name: To check the behaviour of Initialization type Fast.
      ansible.builtin.import_role:
        name: redfish_storage_volume
      vars:
        hostname: "{{ lookup('env', 'IDRAC_IP') }}"
        username: "{{ lookup('env', 'IDRAC_USER') }}"
        password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
        validate_certs: false
        command: initialize
        volume_id: "invalid_volume_id"
        initialize_type: "Fast"
      ignore_errors: true
      register: redfish_storage_volume_result

    - name: Asserting operation for initialization of type Fast.
      ansible.builtin.assert:
        that: redfish_storage_volume_out.msg == "Specified Volume Id invalid_volume_id does not exist in the System."

    - name: Running for Initialization type scenarios
      block:
        - name: To check the behaviour of Initialization type Fast.
          ansible.builtin.import_role:
            name: redfish_storage_volume
          vars:
            hostname: "{{ lookup('env', 'IDRAC_IP') }}"
            username: "{{ lookup('env', 'IDRAC_USER') }}"
            password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
            validate_certs: false
            command: initialize
            volume_id: "{{ redfish_storage_volume_id }}"
            initialize_type: "Fast"
            job_wait: false

        - name: Asserting operation for initialization type Fast.
          ansible.builtin.assert:
            that: redfish_storage_volume_out.msg == "Successfully submitted initialize volume task."

        - name: Track the initialization job
          ansible.builtin.include_tasks:
            file: ../__job_track.yml
          vars:
            job_id: "{{ redfish_storage_volume_out.job_status.Id }}"

        - name: To check the behaviour of Initialization type Slow.
          ansible.builtin.import_role:
            name: redfish_storage_volume
          vars:
            hostname: "{{ lookup('env', 'IDRAC_IP') }}"
            username: "{{ lookup('env', 'IDRAC_USER') }}"
            password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
            validate_certs: false
            command: initialize
            volume_id: "{{ redfish_storage_volume_id }}"
            initialize_type: "Slow"
            job_wait: true

        - name: Asserting operation for initialization type Slow.
          ansible.builtin.assert:
            that: redfish_storage_volume_out.msg == "The job is successfully completed."
