- name: Generate certificate
  ibm.storage_virtualize.ibm_svctask_command:
    command: "svctask chsystemcert -mksystemsigned"
    clustername: "{{ item.cluster_ip }}"
    username: "{{ item.cluster_username }}"
    password: "{{ item.cluster_password }}"
    log_path: "{{ log_path }}"
  loop: "{{ clusters }}"

- name: Export SSL certificate internally
  ibm.storage_virtualize.ibm_sv_manage_ssl_certificate:
    clustername: "{{ item.cluster_ip }}"
    username: "{{ item.cluster_username }}"
    password: "{{ item.cluster_password }}"
    log_path: "{{ log_path }}"
    certificate_type: "system"
  loop: "{{ clusters }}"

- name: Create truststore on primary
  ibm.storage_virtualize.ibm_sv_manage_truststore_for_replication:
    clustername: "{{ clusters[0].cluster_ip }}"
    username: "{{ clusters[0].cluster_username }}"
    password: "{{ clusters[0].cluster_password }}"
    log_path: "{{ log_path }}"
    name: "{{ clusters[0].truststore_name }}"
    remote_clustername: "{{ clusters[1].cluster_ip }}"
    remote_username: "{{ clusters[1].cluster_username }}"
    remote_password: "{{ clusters[1].cluster_password }}"
    state: "present"
    restapi: "on"

- name: Create truststore on secondary
  ibm.storage_virtualize.ibm_sv_manage_truststore_for_replication:
    clustername: "{{ clusters[1].cluster_ip }}"
    username: "{{ clusters[1].cluster_username }}"
    password: "{{ clusters[1].cluster_password }}"
    log_path: "{{ log_path }}"
    name: "{{ clusters[1].truststore_name }}"
    remote_clustername: "{{ clusters[0].cluster_ip }}"
    remote_username: "{{ clusters[0].cluster_username }}"
    remote_password: "{{ clusters[0].cluster_password }}"
    state: "present"
    restapi: "on"

- name: Initiate FC partnership from primary cluster
  ibm.storage_virtualize.ibm_sv_manage_fc_partnership:
    clustername: "{{ clusters[0].cluster_ip }}"
    username: "{{ clusters[0].cluster_username }}"
    password: "{{ clusters[0].cluster_password }}"
    log_path: "{{ log_path }}"
    remote_clustername: "{{ clusters[1].cluster_ip }}"
    remote_username: "{{ clusters[1].cluster_username }}"
    remote_password: "{{ clusters[1].cluster_password }}"
    remote_system: "{{ clusters[1].cluster_name }}"
    linkbandwidthmbits: 50
    backgroundcopyrate: 50
    start: 'True'
    state: present

- name: Complete FC partnership from secondary cluster
  ibm.storage_virtualize.ibm_sv_manage_fc_partnership:
    clustername: "{{ clusters[1].cluster_ip }}"
    username: "{{ clusters[1].cluster_username }}"
    password: "{{ clusters[1].cluster_password }}"
    log_path: "{{ log_path }}"
    remote_clustername: "{{ clusters[0].cluster_ip }}"
    remote_username: "{{ clusters[0].cluster_username }}"
    remote_password: "{{ clusters[0].cluster_password }}"
    remote_system: "{{ clusters[0].cluster_name }}"
    linkbandwidthmbits: 50
    backgroundcopyrate: 50
    start: 'True'
    state: present

- name: Enable PBR on partnership on both sides
  ibm.storage_virtualize.ibm_sv_manage_fc_partnership:
    clustername: "{{ clusters[0].cluster_ip }}"
    username: "{{ clusters[0].cluster_username }}"
    password: "{{ clusters[0].cluster_password }}"
    log_path: "{{ log_path }}"
    remote_clustername: "{{ clusters[1].cluster_ip }}"
    remote_username: "{{ clusters[1].cluster_username }}"
    remote_password: "{{ clusters[1].cluster_password }}"
    remote_system: "{{ clusters[1].cluster_name }}"
    state: present
    pbrinuse: "yes"
