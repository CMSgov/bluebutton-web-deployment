---
- name: Generate certificate.
  ibm.storage_virtualize.ibm_svctask_command:
    command: "svctask chsystemcert -mksystemsigned"
    clustername: "{{ item.cluster_ip }}"
    username: "{{ item.cluster_username }}"
    password: "{{ item.cluster_password }}"
    log_path: "{{ log_path | default('/tmp/ansiblePB.debug') }}"
  loop: "{{ clusters_data }}"

- name: Export SSL certificate internally
  ibm.storage_virtualize.ibm_sv_manage_ssl_certificate:
    clustername: "{{ item.cluster_ip }}"
    username: "{{ item.cluster_username }}"
    password: "{{ item.cluster_password }}"
    log_path: "{{ log_path | default('/tmp/ansiblePB.debug') }}"
    certificate_type: "system"
  loop: "{{ clusters_data }}"

- name: Create truststore on primary
  ibm.storage_virtualize.ibm_sv_manage_truststore_for_replication:
    clustername: "{{ clusters_data[0].cluster_ip }}"
    username: "{{ clusters_data[0].cluster_username }}"
    password: "{{ clusters_data[0].cluster_password }}"
    log_path: "{{ log_path | default('/tmp/ansiblePB.debug') }}"
    name: trust_primary
    remote_clustername: "{{ clusters_data[1].cluster_ip }}"
    remote_username: "{{ clusters_data[1].cluster_username }}"
    remote_password: "{{ clusters_data[1].cluster_password }}"
    state: "present"

- name: Create truststore on secondary
  ibm.storage_virtualize.ibm_sv_manage_truststore_for_replication:
    clustername: "{{ clusters_data[1].cluster_ip }}"
    username: "{{ clusters_data[1].cluster_username }}"
    password: "{{ clusters_data[1].cluster_password }}"
    log_path: "{{ log_path | default('/tmp/ansiblePB.debug') }}"
    name: trust_secondary
    remote_clustername: "{{ clusters_data[0].cluster_ip }}"
    remote_username: "{{ clusters_data[0].cluster_username }}"
    remote_password: "{{ clusters_data[0].cluster_password }}"
    state: "present"

- name: Enable PBR on partnership on both sides
  ibm.storage_virtualize.ibm_sv_manage_fc_partnership:
    clustername: "{{ clusters_data[0].cluster_ip }}"
    username: "{{ clusters_data[0].cluster_username }}"
    password: "{{ clusters_data[0].cluster_password }}"
    log_path: "{{ log_path | default('/tmp/ansiblePB.debug') }}"
    remote_clustername: "{{ clusters_data[1].cluster_ip }}"
    remote_username: "{{ clusters_data[1].cluster_username }}"
    remote_password: "{{ clusters_data[1].cluster_password }}"
    remote_system: "{{ clusters_data[1].cluster_name }}"
    state: present
    pbrinuse: "yes"
